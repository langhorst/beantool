#!/usr/bin/env ruby

require 'optparse'
require File.join(File.dirname(__FILE__), '..', 'lib', 'beantool')

options = Hash.new
beanfile = File.join(ENV['HOME'], '.beantool')
options[:addrs] = File.exist?(beanfile) ? IO.readlines(beanfile) : Array.new

OptionParser.new do |opts|
  opts.banner = "Usage: beantool [options]"

  opts.on("-a", "--address [ADDRESS]", "Beanstalkd address") do |addr|
    options[:addrs] ||= Array.new
    options[:addrs] << addr
  end
  opts.on("-e", "--export [TUBE]", "Export tube") { |tube| options[:export] = tube }
  opts.on("-f", "--filename [FILENAME]", "Filename for import/export") { |file| options[:filename] = file }
  opts.on("-i", "--import [TUBE]", "Import tube") { |tube| options[:import] = tube }
  opts.on("-l", "--list-tubes", "List tubes") { |o| options[:list] = true }
  opts.on("-p", "--peek [TUBE]", "Peek tube") { |o| options[:peek] = o }
  opts.on("-P", "--purge [TUBE]", "Purge tube") { |o| options[:purge] = o }
  opts.on("-s", "--stats", "Stats") { |o| options[:stats] = true }
  opts.on("-S", "--raw-stats", "Raw stats") { |o| options[:raw_stats] = true }
  opts.on("-t", "--tube-stats [TUBE]", "Tube stats") { |o| options[:tube_stats] = o }
  opts.on("-T", "--raw-tube-stats [TUBE]", "Raw tube stats") { |o| options[:tube_stats_raw] = o }
  opts.on("-v", "--version", "Version") { |o| options[:version] = true } 
end.parse!

beantool = Beantool.new(options[:addrs])
if options[:export]
  beantool.export(options[:export], options[:filename] || options[:export]+'.yaml')
end
if options[:import]
  beantool.import(options[:import], options[:filename] || options[:import]+'.yaml')
end
if options[:peek]
  puts beantool.peek(options[:peek])
end
if options[:list]
  puts beantool.list_tubes
end
if options[:purge]
  puts beantool.purge(options[:purge])
end
if options[:stats]
  puts beantool.stats
end
if options[:raw_stats]
  puts beantool.raw_stats
end
if options[:version]
  puts beantool.version
end
if options[:tube_stats]
  puts beantool.tube_stats(options[:tube_stats])
end
if options[:tube_stats_raw]
  puts beantool.tube_stats_raw(options[:tube_stats_raw])
end

